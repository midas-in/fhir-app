"use strict";(self.webpackChunkfhircore=self.webpackChunkfhircore||[]).push([[7892],{4819:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>a});var r=i(5893),s=i(1151);const t={sidebar_label:"Keycloak"},o="",c={id:"engineering/backend/keycloak",title:"keycloak",description:"Keycloak user management",source:"@site/docs/engineering/backend/keycloak.mdx",sourceDirName:"engineering/backend",slug:"/engineering/backend/keycloak",permalink:"/engineering/backend/keycloak",draft:!1,unlisted:!1,editUrl:"https://github.com/opensrp/fhircore/tree/main/docs/engineering/backend/keycloak.mdx",tags:[],version:"current",frontMatter:{sidebar_label:"Keycloak"},sidebar:"defaultSidebar",previous:{title:"FHIR Gateway",permalink:"/engineering/backend/info-gateway"},next:{title:"Production setup",permalink:"/engineering/backend/production"}},l={},a=[{value:"Keycloak user management",id:"keycloak-user-management",level:2},{value:"Keycloak auth token configuration",id:"keycloak-auth-token-configuration",level:3},{value:"Configuring Keycloak for fhir-web",id:"configuring-keycloak-for-fhir-web",level:2},{value:"Notes",id:"notes",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:""}),"\n",(0,r.jsx)(n.h2,{id:"keycloak-user-management",children:"Keycloak user management"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Create the user on Keycloak"}),"\n",(0,r.jsxs)(n.li,{children:["Create the required groups, e.g. create the ",(0,r.jsx)(n.code,{children:"PROVIDER"})," and ",(0,r.jsx)(n.code,{children:"SUPERVISOR"})," groups"]}),"\n",(0,r.jsxs)(n.li,{children:["Create roles for all the resources your application uses, e.g. for permissions on the ",(0,r.jsx)(n.code,{children:"Patient"})," resource create the roles ",(0,r.jsx)(n.code,{children:"GET_PATIENT"}),", ",(0,r.jsx)(n.code,{children:"PUT_PATIENT"}),", ",(0,r.jsx)(n.code,{children:"POST_PATIENT"}),". The KeyCloak definition is as follows:","\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"HTTP"})," methods define the permissions a user can have on any endpoint. We also use an additional ",(0,r.jsx)(n.code,{children:"Manage"})," role which is a composite of the 4 ",(0,r.jsx)(n.code,{children:"HTTP"})," method roles"]}),"\n",(0,r.jsxs)(n.li,{children:["The Permissions checker plugin currently handles the ",(0,r.jsx)(n.code,{children:"POST"}),", ",(0,r.jsx)(n.code,{children:"GET"}),", ",(0,r.jsx)(n.code,{children:"PUT"}),", ",(0,r.jsx)(n.code,{children:"DELETE"})," HTTP methods"]}),"\n",(0,r.jsxs)(n.li,{children:["The permissions use the following format: ",(0,r.jsx)(n.code,{children:"[HTTP_METHOD]_[RESOURCE_NAME]"}),". Where ",(0,r.jsx)(n.code,{children:"RESOURCE_NAME"})," is the FHIR resource name, e.g ",(0,r.jsx)(n.code,{children:"Patient"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," Keycloak Roles are case sensitive. OpenSRP 2 uses uppercase letters in its role naming."]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsxs)(n.li,{children:["Assign the roles to the corresponding group, e.g. for the above assign to ",(0,r.jsx)(n.code,{children:"PROVIDER"})]}),"\n",(0,r.jsx)(n.li,{children:"Assign the created Group, e.g. Provider to the user"}),"\n",(0,r.jsxs)(n.li,{children:["Add a new user attribute with the key ",(0,r.jsx)(n.code,{children:"fhir_core_app_id"})," and a value corresponding to the user\u2019s assigned android client application id on the Composition resource (",(0,r.jsx)(n.code,{children:"composition_config.json"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["Create a protocol mapper with Mapper Type ",(0,r.jsx)(n.code,{children:"User Attribute"})," at the client level, area path (Keycloak v20+) ",(0,r.jsx)(n.code,{children:"Clients"})," > ",(0,r.jsx)(n.code,{children:"Client Details"})," > ",(0,r.jsx)(n.code,{children:"Dedicated Scopes"})," > ",(0,r.jsx)(n.code,{children:"Add mapper"}),". The ",(0,r.jsx)(n.strong,{children:"User attribute"})," and ",(0,r.jsx)(n.strong,{children:"Token claim name"})," field values should match the attribute key ",(0,r.jsx)(n.code,{children:"fhir_core_app_id"})," created in the previous step.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["For keycloak below v20, ",(0,r.jsx)(n.code,{children:"Clients"})," > ",(0,r.jsx)(n.code,{children:"your-client-id"})," >",(0,r.jsx)(n.code,{children:" Mappers"})," > ",(0,r.jsx)(n.code,{children:"Create"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"keycloak-auth-token-configuration",children:"Keycloak auth token configuration"}),"\n",(0,r.jsx)(n.p,{children:"When making API requests, the app uses an access token that represent authorization to access resources on the server."}),"\n",(0,r.jsx)(n.p,{children:"When the access token expires, the app will attempt to renew it using a refresh token."}),"\n",(0,r.jsxs)(n.p,{children:["The access token lifespan is configured on Keycloak as the ",(0,r.jsx)(n.code,{children:"Access Token Lifespan"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The refresh token lifespan will be equal to the smallest value among (",(0,r.jsx)(n.code,{children:"SSO Session Idle"}),", ",(0,r.jsx)(n.code,{children:"Client Session Idle"}),", ",(0,r.jsx)(n.code,{children:"SSO Session Max"}),", and ",(0,r.jsx)(n.code,{children:"Client Session Max"}),")."]}),"\n",(0,r.jsx)(n.p,{children:"When setting up identity and access management via Keycloak, the access and refresh token values are required to ensure the access token renewal works as expected in the app."}),"\n",(0,r.jsx)(n.h2,{id:"configuring-keycloak-for-fhir-web",children:"Configuring Keycloak for fhir-web"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Navigate to the Keycloak Admin UI, e.g ",(0,r.jsx)(n.code,{children:"http://keycloak:8080"})]}),"\n",(0,r.jsxs)(n.li,{children:["Create realm with name ",(0,r.jsx)(n.code,{children:"fhir"})," or anything else"]}),"\n",(0,r.jsxs)(n.li,{children:['In the realm previously created, create new Client Scope "fhir_core_app_id", set it as Default, and add mapper user attribute ',(0,r.jsx)(n.code,{children:"fhir_core_app_id"})]}),"\n",(0,r.jsxs)(n.li,{children:["Create client for OpenSRP v2.0 client-side application, e.g. ",(0,r.jsx)(n.code,{children:"opensrp-v2-app-client"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:['In "Capability config", turn on "Client authentication".',"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"When it is ON, the OIDC type is set to confidential access type. When it is OFF, it is set to public access type)"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:['Set "Valid redirect URIs" to ',(0,r.jsx)(n.code,{children:"*"})," or other as needed"]}),"\n",(0,r.jsx)(n.li,{children:'Copy & paste the client secret from "Credentials" tab'}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Create client for ",(0,r.jsx)(n.code,{children:"fhir-web"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'In "Capability config", turn on "Client authentication".'}),"\n",(0,r.jsxs)(n.li,{children:['Set "Valid redirect URIs" to the domain name of your ',(0,r.jsx)(n.code,{children:"fhir-web"})," installation + wildcard as suffix, e.g. ",(0,r.jsx)(n.code,{children:"https://fhir-web.example.org/*"})," or other as needed"]}),"\n",(0,r.jsxs)(n.li,{children:['Set "Valid post logout redirect URIs" to the domain name of your ',(0,r.jsx)(n.code,{children:"fhir-web"})," installation + wildcard as suffix, e.g. ",(0,r.jsx)(n.code,{children:"https://fhir-web.example.org/*"})," or other as needed"]}),"\n",(0,r.jsxs)(n.li,{children:['Set "Web origins" to the domain name of your ',(0,r.jsx)(n.code,{children:"fhir-web"})," installation, e.g. ",(0,r.jsx)(n.code,{children:"https://fhir-web.example.org"})," or other as needed"]}),"\n",(0,r.jsx)(n.li,{children:'Copy the client secret from the "Credentials" tab, paste it wherever needed'}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Create realm roles based on ",(0,r.jsx)(n.a,{href:"https://docs.google.com/document/d/1MEw41Rtfdmos9gqqDamQ31_Y58E8Thgo_8i9UXD8ET4/edit",children:"OpenSRP V2 RBAC ROLES"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"TODO:"})," Add script + payload to load all these to the Keycloak instance"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:['Create the groups "Super Admin" and "Provider"',"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:'Add roles in the "Role Mapping"'}),"\n",(0,r.jsxs)(n.li,{children:["Add attribute ",(0,r.jsx)(n.code,{children:"fhir_core_app_id"})," in the group, or in each user"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"notes",children:"Notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Create users via ",(0,r.jsx)(n.code,{children:"fhir-web"}),'. This helps by automatically creating the additional required FHIR resources of "',(0,r.jsx)(n.a,{href:"http://hl7.org/fhir/R4/practitioner.html",children:"Practitioner"}),'" and "',(0,r.jsx)(n.a,{href:"http://hl7.org/fhir/R4/practitionerrole.html",children:"PractitionerRole"}),'" for new users / healthcare workers.']}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1151:(e,n,i)=>{i.d(n,{Z:()=>c,a:()=>o});var r=i(7294);const s={},t=r.createContext(s);function o(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);